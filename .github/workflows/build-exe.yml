name: Build and Release

on:
  push:
    tags: [ 'v*' ]  # åªåœ¨æ¨é€æ ‡ç­¾æ—¶è§¦å‘å‘å¸ƒ
  workflow_dispatch:

jobs:
  release-build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PyQt5
        pip install selenium
        pip install requests
        # Install other dependencies if requirements.txt exists
        if (Test-Path requirements.txt) { pip install -r requirements.txt }
        
    - name: Download Latest ChromeDriver
      run: |
        # Create test directory if it doesn't exist
        if (!(Test-Path "test")) { New-Item -ItemType Directory -Path "test" }

        try {
          # Get the latest stable Chrome version from the Chrome for Testing API
          Write-Host "ğŸ” Fetching latest Chrome version..."
          $chromeVersionsUrl = "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json"
          $versionInfo = Invoke-RestMethod -Uri $chromeVersionsUrl
          $latestVersion = $versionInfo.channels.Stable.version

          Write-Host "ğŸ“¦ Latest Chrome version: $latestVersion"

          # Download ChromeDriver for the latest version
          $driverUrl = "https://storage.googleapis.com/chrome-for-testing-public/$latestVersion/win32/chromedriver-win32.zip"
          Write-Host "â¬‡ï¸ Downloading ChromeDriver from: $driverUrl"

          Invoke-WebRequest -Uri $driverUrl -OutFile "chromedriver.zip"
          Expand-Archive -Path "chromedriver.zip" -DestinationPath "temp" -Force
          Move-Item "temp/chromedriver-win32/chromedriver.exe" "test/chromedriver.exe" -Force
          Remove-Item "chromedriver.zip", "temp" -Recurse -Force

          Write-Host "âœ… ChromeDriver downloaded successfully: $latestVersion"

        } catch {
          Write-Host "âŒ Failed to download latest ChromeDriver: $_"
          Write-Host "ğŸ”„ Trying fallback method..."

          # Fallback: try a known stable version
          $fallbackVersion = "131.0.6778.87"
          $fallbackUrl = "https://storage.googleapis.com/chrome-for-testing-public/$fallbackVersion/win32/chromedriver-win32.zip"

          try {
            Write-Host "â¬‡ï¸ Downloading fallback ChromeDriver: $fallbackVersion"
            Invoke-WebRequest -Uri $fallbackUrl -OutFile "chromedriver.zip"
            Expand-Archive -Path "chromedriver.zip" -DestinationPath "temp" -Force
            Move-Item "temp/chromedriver-win32/chromedriver.exe" "test/chromedriver.exe" -Force
            Remove-Item "chromedriver.zip", "temp" -Recurse -Force
            Write-Host "âœ… Fallback ChromeDriver downloaded successfully"
          } catch {
            Write-Host "âŒ Fallback download also failed: $_"
            Write-Host "âš ï¸ Build will continue without ChromeDriver"
          }
        }
        
    - name: Build executable with PyInstaller
      run: |
        # Build the main application
        pyinstaller --onefile --windowed --icon=icons/badminton_ico.ico --name="BadmintonScript" script_final_beta.py
        
        # Copy necessary files to dist folder
        Copy-Item "congfig.txt" "dist/" -ErrorAction SilentlyContinue
        Copy-Item "test/chromedriver.exe" "dist/" -ErrorAction SilentlyContinue
        Copy-Item "icons" "dist/" -Recurse -ErrorAction SilentlyContinue
        Copy-Item "pics" "dist/" -Recurse -ErrorAction SilentlyContinue
        
    - name: Create release package
      run: |
        # Create a release folder
        New-Item -ItemType Directory -Path "release" -Force
        
        # Copy executable and required files
        Copy-Item "dist/BadmintonScript.exe" "release/"
        Copy-Item "congfig.txt" "release/" -ErrorAction SilentlyContinue
        Copy-Item "test/chromedriver.exe" "release/" -ErrorAction SilentlyContinue
        Copy-Item "icons" "release/" -Recurse -ErrorAction SilentlyContinue
        Copy-Item "pics" "release/" -Recurse -ErrorAction SilentlyContinue
        
        # Create README for release
        @"
        # Badminton Script v3.0
        
        ## ä½¿ç”¨è¯´æ˜
        1. è¿è¡Œ BadmintonScript.exe
        2. é…ç½®ä½ çš„è´¦å·ä¿¡æ¯å’Œé¢„çº¦è®¾ç½®
        3. ç‚¹å‡»å¯åŠ¨å¼€å§‹è‡ªåŠ¨é¢„çº¦
        
        ## æ–‡ä»¶è¯´æ˜
        - BadmintonScript.exe: ä¸»ç¨‹åº
        - chromedriver.exe: Chromeæµè§ˆå™¨é©±åŠ¨
        - congfig.txt: é…ç½®æ–‡ä»¶æ¨¡æ¿
        - icons/: å›¾æ ‡æ–‡ä»¶
        - pics/: å›¾ç‰‡èµ„æº
        
        ## æ³¨æ„äº‹é¡¹
        - ç¡®ä¿ç³»ç»Ÿå·²å®‰è£…Chromeæµè§ˆå™¨
        - é¦–æ¬¡è¿è¡Œå‰è¯·ä¿®æ”¹congfig.txtä¸­çš„é…ç½®ä¿¡æ¯
        - å»ºè®®åœ¨é¢„çº¦å¼€æ”¾å‰å‡ åˆ†é’Ÿå¯åŠ¨ç¨‹åº
        "@ | Out-File -FilePath "release/README.md" -Encoding UTF8
        
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path "release/*" -DestinationPath "BadmintonScript-Windows.zip"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: BadmintonScript-Windows
        path: BadmintonScript-Windows.zip
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: BadmintonScript-Windows.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-alternative:
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller PyQt5 selenium requests
        
    - name: Build with different options
      run: |
        # Build console version for debugging
        pyinstaller --onefile --console --icon=icons/badminton_ico.ico --name="BadmintonScript-Console" script_final_beta.py
        
        # Build directory version (not single file)
        pyinstaller --windowed --icon=icons/badminton_ico.ico --name="BadmintonScript-Dir" script_final_beta.py
        
    - name: Upload alternative builds
      uses: actions/upload-artifact@v4
      with:
        name: BadmintonScript-Alternative-Builds
        path: |
          dist/BadmintonScript-Console.exe
          dist/BadmintonScript-Dir/
        retention-days: 7
