name: Manual Build EXE

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug
        - both
      include_chromedriver:
        description: 'Include ChromeDriver'
        required: true
        default: true
        type: boolean

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Download Latest ChromeDriver
      if: ${{ github.event.inputs.include_chromedriver == 'true' }}
      run: |
        # Ensure test directory exists
        if (!(Test-Path "test")) {
          New-Item -ItemType Directory -Path "test"
        }

        try {
          # Get the latest stable Chrome version
          Write-Host "ğŸ” Fetching latest Chrome version..."
          $chromeVersionsUrl = "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json"
          $versionInfo = Invoke-RestMethod -Uri $chromeVersionsUrl
          $latestVersion = $versionInfo.channels.Stable.version

          Write-Host "ğŸ“¦ Latest Chrome version: $latestVersion"

          # Download ChromeDriver for the latest version
          $driverUrl = "https://storage.googleapis.com/chrome-for-testing-public/$latestVersion/win32/chromedriver-win32.zip"
          Write-Host "â¬‡ï¸ Downloading ChromeDriver from: $driverUrl"

          Invoke-WebRequest -Uri $driverUrl -OutFile "chromedriver.zip"
          Expand-Archive -Path "chromedriver.zip" -DestinationPath "temp" -Force
          Move-Item "temp/chromedriver-win32/chromedriver.exe" "test/chromedriver.exe" -Force
          Remove-Item "chromedriver.zip", "temp" -Recurse -Force

          Write-Host "âœ… ChromeDriver downloaded successfully: $latestVersion"

        } catch {
          Write-Host "âŒ Failed to download latest ChromeDriver: $_"
          Write-Host "ğŸ”„ Trying fallback version..."

          # Fallback to a known stable version
          $fallbackVersion = "131.0.6778.87"
          $fallbackUrl = "https://storage.googleapis.com/chrome-for-testing-public/$fallbackVersion/win32/chromedriver-win32.zip"

          try {
            Invoke-WebRequest -Uri $fallbackUrl -OutFile "chromedriver.zip"
            Expand-Archive -Path "chromedriver.zip" -DestinationPath "temp" -Force
            Move-Item "temp/chromedriver-win32/chromedriver.exe" "test/chromedriver.exe" -Force
            Remove-Item "chromedriver.zip", "temp" -Recurse -Force
            Write-Host "âœ… Fallback ChromeDriver downloaded successfully"
          } catch {
            Write-Host "âŒ Fallback download also failed: $_"
          }
        }
        
    - name: Build Release Version
      if: ${{ github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both' }}
      run: |
        pyinstaller badminton.spec
        
        # Create release package
        New-Item -ItemType Directory -Path "package" -Force
        Copy-Item "dist/BadmintonScript.exe" "package/"
        
        if (Test-Path "test/chromedriver.exe") {
          Copy-Item "test/chromedriver.exe" "package/"
        }
        
        # Create user guide
        @"
        # ç¾½æ¯›çƒåœºåœ°é¢„çº¦å·¥å…· v3.0
        
        ## å¿«é€Ÿå¼€å§‹
        1. åŒå‡»è¿è¡Œ BadmintonScript.exe
        2. åœ¨ç•Œé¢ä¸­å¡«å…¥ä½ çš„å­¦å·å’Œå¯†ç 
        3. é€‰æ‹©é¢„çº¦æ—¥æœŸå’Œæ—¶é—´
        4. å¡«å†™è”ç³»äººä¿¡æ¯
        5. ç‚¹å‡»"å¯åŠ¨"å¼€å§‹è‡ªåŠ¨é¢„çº¦
        
        ## é…ç½®è¯´æ˜
        - å­¦å·: ä½ çš„ä¸Šç§‘å¤§å­¦å·
        - å¯†ç : ä½ çš„OAç³»ç»Ÿå¯†ç 
        - ä½¿ç”¨æ—¥æœŸ: è¦é¢„çº¦çš„æ—¥æœŸ
        - ä½¿ç”¨åœºåœ°: é€‰æ‹©æ—¶é—´æ®µ
        - ç°åœºè´£ä»»äºº: å¡«å†™è”ç³»äººå§“å
        - è”ç³»ç”µè¯: å¡«å†™è”ç³»äººç”µè¯
        
        ## æ³¨æ„äº‹é¡¹
        - è¯·ç¡®ä¿ç”µè„‘å·²å®‰è£…Chromeæµè§ˆå™¨
        - å»ºè®®åœ¨é¢„çº¦å¼€æ”¾å‰1-2åˆ†é’Ÿå¯åŠ¨ç¨‹åº
        - ç¨‹åºä¼šåœ¨è®¾å®šæ—¶é—´è‡ªåŠ¨æäº¤é¢„çº¦ç”³è¯·
        - æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘æé«˜æˆåŠŸç‡
        
        ## æ•…éšœæ’é™¤
        - å¦‚æœæç¤ºChromeDriveré”™è¯¯ï¼Œè¯·ç¡®ä¿chromedriver.exeåœ¨åŒä¸€ç›®å½•
        - å¦‚æœç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­¦å·å¯†ç æ˜¯å¦æ­£ç¡®
        - å¦‚æœé¢„çº¦å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–åœºåœ°å·²æ»¡
        "@ | Out-File -FilePath "package/ä½¿ç”¨è¯´æ˜.txt" -Encoding UTF8
        
        Compress-Archive -Path "package/*" -DestinationPath "BadmintonScript-Release.zip"
        
    - name: Build Debug Version
      if: ${{ github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'both' }}
      run: |
        pyinstaller --onefile --console --icon=icons/badminton_ico.ico --name="BadmintonScript-Debug" script_final_beta.py
        
        New-Item -ItemType Directory -Path "debug-package" -Force
        Copy-Item "dist/BadmintonScript-Debug.exe" "debug-package/"
        
        if (Test-Path "test/chromedriver.exe") {
          Copy-Item "test/chromedriver.exe" "debug-package/"
        }
        
        Compress-Archive -Path "debug-package/*" -DestinationPath "BadmintonScript-Debug.zip"
        
    - name: Upload Release Build
      if: ${{ github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both' }}
      uses: actions/upload-artifact@v4
      with:
        name: BadmintonScript-Release
        path: BadmintonScript-Release.zip
        retention-days: 30
        
    - name: Upload Debug Build
      if: ${{ github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'both' }}
      uses: actions/upload-artifact@v4
      with:
        name: BadmintonScript-Debug
        path: BadmintonScript-Debug.zip
        retention-days: 7
